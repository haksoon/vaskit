<div style="padding:10px;">
  <div style="margin-bottom:30px;">
    <h2 style="margin:10px 0; padding:0 5px;"><i class="fa fa-check"></i> 비디오 컨텐츠</h2>
    <img id="video_thumbnail_preview" src="" style="display: block; margin: 10px auto; width:100%; max-width: 800px; display: none;">
    <input id="video_thumbnail" class="video_input" type="file"/ onchange="preview_video_thumbnail(this);">
    <input id="video_ask_id" class="video_input" type="text" placeholder="질문 id 입력 (숫자)" />
    <input id="video_title" class="video_input" type="text" placeholder="제목 입력 (A vs B, 제품명 비교!)" />
    <input id="video_url" class="video_input" type="text" placeholder="URL 입력 (16자리 숫자)" />
    <iframe id="video_ask_preview" width="100%" height="320" src="" frameborder="0" allowfullscreen="" style="display:none; outline: 3px solid #ff7200;"></iframe>
    <iframe id="video_preview" width="100%" height="320" src="" frameborder="0" allowfullscreen="" style="display:none; outline: 3px solid #ff7200; margin-top: 10px;"></iframe>
    <a id="video_submit" href="#" onclick="preview_video(); return false;" style="display:block; background-color:#4b3d3d; color:#fff; font-size:14px; margin:10px 0; height:50px; line-height:50px; text-align:center;">미리보기</a>
  </div>
  <div>
    <p style="margin:30px 0 10px; padding:0 5px;"><i class="fa fa-info-circle"></i> 게시 비디오 리스트</p>
    <table border="1" cellspacing="1" cellpadding="2" style="width:100%; font-size:12px; text-align:center;">
      <thead>
        <tr style="height:40px; background-color:#998674; color:#fff;">
          <th style="width:120px;">게시일</th>
          <th>제목</th>
          <th>질문</th>
          <th>링크</th>
        </tr>
      </thead>
      <tbody>
        <% @videos.each do |video| %>
          <tr>
            <td><%=video.created_at.to_date.to_s(:korean_date)%></td>
            <td><%=video.title%></td>
            <td><a href="/asks/<%=video.ask_id%>" target="_blank"><%=video.ask_id%></a></td>
            <td><a href="http://www.facebook.com/vaskit.kr/videos/<%=video.url%>" target="_blank"><i class="fa fa-tv"></i></a></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<style>
  .video_input {
    display:block;
    width:100%;
    height:40px;
    line-height:40px;
    padding:0 10px;
    margin-bottom: 10px;
    -webkit-box-sizing:border-box;
            box-sizing:border-box;
    border:1px solid #dbdbdb;
    color:#666;
    font-size:14px;
    -webkit-appearance:none;
    border-radius:0;
  }
</style>

<script>

  function preview_video_thumbnail(input) {
    var thumbnail_image = $("#video_thumbnail_preview");
    if (input.files && input.files[0]) {
      var reader = new FileReader();
      reader.onload = function(e) {
        thumbnail_image.show().attr("src", e.target.result);
      }
      reader.readAsDataURL(input.files[0]);
    }
  };

  function preview_video() {
    var video_thumbnail = $("#video_thumbnail")[0].files;
    var ask_id = $("#video_ask_id").val();
    var title = $("#video_title").val();
    var url = $("#video_url").val();
    var ask_iframe = $("#video_ask_preview");
    var video_iframe = $("#video_preview");

    if (video_thumbnail.length == 0 || ask_id.length == 0 || title.length == 0 || url.length == 0){
      alert("입력한 항목이 충분하지 않습니다");
    } else {
      alert("미리보기 화면을 확인하신 후\n게시하기 버튼을 눌러주세요");
      ask_id = "/asks/" + ask_id;
      url = "https://www.facebook.com/plugins/video.php?href=https%3A%2F%2Fwww.facebook.com%2Fvaskit.kr%2Fvideos%2F" + url + "%2F&width=500&height=280&show_text=false&appId=<%=Facebook::CONFIG['app_id']%>";
      ask_iframe.attr("src", ask_id).show();
      video_iframe.attr("src", url).show();
      $("#video_submit").attr("onclick", "create_video(); return false;").html("게시하기");
    }
  };

  function create_video() {
    var video_thumbnail = $("#video_thumbnail")[0].files;
    var ask_id = $("#video_ask_id").val();
    var title = $("#video_title").val();
    var url = $("#video_url").val();
    if (video_thumbnail.length == 0 || ask_id.length == 0 || title.length == 0 || url.length == 0){
      alert("입력한 항목이 충분하지 않습니다");
    } else if (confirm("메인화면에 반영하시겠어요?")) {
      var formData = new FormData();
      $.each( video_thumbnail, function( i, file ) {
  	    formData.append('File', file);
        formData.append('ask_id', ask_id);
        formData.append('title', title);
        formData.append('url', url);
      });
      $.ajax({
              url: "/admin/videos.json",
              dataType: 'json',
              type: 'POST',
              data: formData,
              contentType: false,
              processData: false,
              error: function(){
                return false;
              },
              success: function(data){
                location.reload();
              },
              beforeSend: function(){
                $(".loading").show();
              },
              complete: function(){
                $(".loading").hide();
              }
      });
    }
  }
</script>

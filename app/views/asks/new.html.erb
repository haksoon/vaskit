<%= render 'form' %>

<script>
  $(window).on("load",function(){
    $(window).unbind("hashchange");
    history.pushState(null, null, "#welcome");
    $("form").on("change", function(){
      is_edited = true;
    });
    $(window).bind("hashchange", function(e){
      var left_deal_image_url_in_progress = $("#left_deal_image_btn").find("img").attr("src"),
          right_deal_image_url_in_progress = $("#right_deal_image_btn").find("img").attr("src"),
          left_deal_title_in_progress = $("#left_deal_title").val(),
          right_deal_title_in_progress = $("#right_deal_title").val(),
          left_deal_brand_in_progress = $("#left_deal_brand").val(),
          right_deal_brand_in_progress = $("#right_deal_brand").val(),
          left_deal_price_in_progress = $("#left_deal_price").val(),
          right_deal_price_in_progress = $("#right_deal_price").val(),
          left_deal_link_in_progress = $("#left_deal_link").val(),
          right_deal_link_in_progress = $("#right_deal_link").val(),
          left_deal_spec1_in_progress = $("#left_deal_spec1").val(),
          right_deal_spec1_in_progress = $("#right_deal_spec1").val(),
          left_deal_spec2_in_progress = $("#left_deal_spec2").val(),
          right_deal_spec2_in_progress = $("#right_deal_spec2").val(),
          left_deal_spec3_in_progress = $("#left_deal_spec3").val(),
          right_deal_spec3_in_progress = $("#right_deal_spec3").val();
      ask_in_progress.category_id = $("#ask_category_id").val();
      ask_in_progress.message = $("#ask_message").val();
      ask_in_progress.left_ask_deal_in_progress = {left_deal_image_url:left_deal_image_url_in_progress, left_deal_title:left_deal_title_in_progress, left_deal_brand:left_deal_brand_in_progress, left_deal_price:left_deal_price_in_progress, left_deal_link:left_deal_link_in_progress, left_deal_spec1:left_deal_spec1_in_progress, left_deal_spec2:left_deal_spec2_in_progress, left_deal_spec3:left_deal_spec3_in_progress};
      ask_in_progress.right_ask_deal_in_progress = {right_deal_image_url:right_deal_image_url_in_progress, right_deal_title:right_deal_title_in_progress, right_deal_brand:right_deal_brand_in_progress, right_deal_price:right_deal_price_in_progress, right_deal_link:right_deal_link_in_progress, right_deal_spec1:right_deal_spec1_in_progress, right_deal_spec2:right_deal_spec2_in_progress, right_deal_spec3:right_deal_spec3_in_progress};
      ask_in_progress.spec1 = $("#ask_spec1").val();
      ask_in_progress.spec2 = $("#ask_spec2").val();
      ask_in_progress.spec3 = $("#ask_spec3").val();
      if (is_user_opened) {
        user_off();
      } else if (window.location.hash == "") {
        history.back();
			} else {
        return false;
      }
    });
    $(document).keydown(function(e){
      if(e.target.nodeName != "INPUT" && e.target.nodeName != "TEXTAREA"){
        if(e.keyCode === 27){
          if (is_user_opened) {
            history.back();
          }	else {
            return false;
          }
        }
      }
    });
    //
    $(window).bind('beforeunload', function(event){
      history.replaceState(null, null, "#welcome");
      return "게시글 작성을 중단하시겠습니까?";
    });
    $(document).on("submit", "form", function(event){
      $(window).off('beforeunload');
    });
  	//
  });

  if (!!ask_in_progress.left_ask_deal_in_progress.left_deal_image_url && ask_in_progress.left_ask_deal_in_progress.left_deal_image_url != '/images/custom/card_image_preview.png') {
    $("#left_deal_image_btn").find("img").attr("src",ask_in_progress.left_ask_deal_in_progress.left_deal_image_url);
    $("#card_a_img_overlay").hide();
  }
  if (!!ask_in_progress.right_ask_deal_in_progress.right_deal_image_url && ask_in_progress.right_ask_deal_in_progress.right_deal_image_url != '/images/custom/card_image_preview.png') {
    $("#right_deal_image_btn").find("img").attr("src",ask_in_progress.right_ask_deal_in_progress.right_deal_image_url);
    $("#card_b_img_overlay").hide();
  }

  if (is_card_overlay_opened) show_card_overlay();

  $("#left_deal_title").val(ask_in_progress.left_ask_deal_in_progress.left_deal_title),
  $("#right_deal_title").val(ask_in_progress.right_ask_deal_in_progress.right_deal_title),
  $("#left_deal_brand").val(ask_in_progress.left_ask_deal_in_progress.left_deal_brand),
  $("#right_deal_brand").val(ask_in_progress.right_ask_deal_in_progress.right_deal_brand),
  $("#left_deal_price").val(ask_in_progress.left_ask_deal_in_progress.left_deal_price),
  $("#right_deal_price").val(ask_in_progress.right_ask_deal_in_progress.right_deal_price),
  $("#left_deal_link").val(ask_in_progress.left_ask_deal_in_progress.left_deal_link),
  $("#right_deal_link").val(ask_in_progress.right_ask_deal_in_progress.right_deal_link),
  $("#left_deal_spec1").val(ask_in_progress.left_ask_deal_in_progress.left_deal_spec1),
  $("#right_deal_spec1").val(ask_in_progress.right_ask_deal_in_progress.right_deal_spec1),
  $("#left_deal_spec2").val(ask_in_progress.left_ask_deal_in_progress.left_deal_spec2),
  $("#right_deal_spec2").val(ask_in_progress.right_ask_deal_in_progress.right_deal_spec2),
  $("#left_deal_spec3").val(ask_in_progress.left_ask_deal_in_progress.left_deal_spec3),
  $("#right_deal_spec3").val(ask_in_progress.right_ask_deal_in_progress.right_deal_spec3);
  $("#ask_category_id").val(ask_in_progress.category_id);
  $("#ask_message").val(ask_in_progress.message);
  $("#ask_spec1").val(ask_in_progress.spec1);
  $("#ask_spec2").val(ask_in_progress.spec2);
  $("#ask_spec3").val(ask_in_progress.spec3);
</script>

<script type="text/template" id="asksListTemplate">
  <div class="container main" ontouchstart="removeIOSRubberEffect($(this));" onscroll="endless_loading($(this), 'asks');" url="{{= url }}">
    {{ if (asks == null || asks.length == 0) { }}
      <div class="no_result"><span class="align_middle">일치하는 결과가 없습니다</span></div>
    {{ } else { }}
      {{ if (check_tutorial('vote')) go_url('tutorial_vote') }}
      <div class="clearfix">
        {{ var l = asks.length }}
        {{ for (var i=0; i < l; i++) { }}
          {{ var ask = asks[i] }}
          {{= askThumbnailTemplate({ ask: ask }) }}
        {{ } }}
        {{ if (l >= <%= Ask::ASK_PER %>) { }}
          <div class="loading_icon" page="2" loading="true"><i class="fa fa-spinner fa-spin"></i></div>
        {{ } else { }}
          <div class="loading_icon" page="2">- End of Contents -</i></div>
        {{ } }}
      </div>
    {{ } }}
  </div>
</script>

<script type="text/template" id="askThumbnailTemplate">
  {{ var my_vote = [] }}
  {{ var is_voted = false }}
  {{ var vote_id = '' }}
  {{ var vote_direction = '' }}
  {{ if (current_user && current_user.id == ask.user_id) { }}
    {{ is_voted = true }}
    {{ vote_id = '' }}
    {{ vote_direction = '' }}
  {{ } else if (current_user) { }}
    {{ my_vote = $.grep(ask.votes, function(obj) { return (obj.user_id == current_user.id) }) }}
    {{ if (my_vote.length > 0) { }}
      {{ vote_id = my_vote[0].id }}
      {{ is_voted = true }}
      {{ vote_direction = ask.left_ask_deal_id == my_vote[0].ask_deal_id ? 'left' : 'right' }}
    {{ } }}
  {{ } else { }}
    {{ var my_votes = [] }}
    {{ var votes = $.cookie('visitor_votes') }}
    {{ var votes_array = (votes == null || votes == '') ? new Array() : votes.split('.') }}
    {{ for (var i=0; i < votes_array.length; i++) { }}
      {{ var vote = votes_array[i] }}
      {{ vote = JSON.parse(vote) }}
      {{ my_votes.push(vote) }}
    {{ } }}
    {{ my_vote = $.grep(my_votes, function(obj) { return (obj.ask_id == ask.id) }) }}
    {{ if (my_vote.length > 0) { }}
      {{ vote_id = my_vote[0].id }}
      {{ is_voted = true }}
      {{ vote_direction = my_vote[0].is_left ? 'left' : 'right' }}
    {{ } }}
  {{ } }}
  {{ var left_count = ask.left_ask_deal.vote_count }}
  {{ var right_count = ask.right_ask_deal.vote_count }}
  {{ var total_count = left_count + right_count }}
  <div href="/asks/{{= ask.id }}" class="ask ask_thumbnail {{= ask.id == 1959 ? 'event_ask' : '' }} contents_box ask_{{= ask.id }} {{= is_voted ? 'is_voted' : '' }}" onclick="go_url('ask', {{= ask.id }}); return false;" ask-id="{{= ask.id }}">
    {{ if (ask.id == 1959) { }}
      <div class="event_info">
        <span class="event_title">📍 프로-리뷰왕 이벤트 진행중!</span>
        {{ var remain_days = Math.floor((new Date('March 14, 2017').getDate() - new Date().getDate())) }}
        {{ remain_days = remain_days > 0 ? remain_days + '일 남음' : '오늘 종료됩니다!' }}
        <span class="event_d_day"><i class="fa fa-clock-o"></i> {{= remain_days }}</span>
      </div>
    {{ } }}
    <div class="clearfix">
      {{ var already_like = false }}
      {{ if (current_user) { }}
        {{ var already_like = $.grep(ask.ask_likes, function(obj) { return (obj.user_id == current_user.id) }).length > 0 ? true : false }}
      {{ } }}
      <div class="ask_user">
        <img class="ask_user_pic" src="{{= get_avatar(ask.user) }}">
        {{ var gender = ask.user.gender ? 'male' : 'female' }}
        {{ if (ask.user.id == 1) { }}
          <span class="ask_user_id vaskit">VASKIT</span>
        {{ } else if (current_user && ask.user.id == current_user.id) { }}
          <span class="ask_user_id">{{= ask.user.string_id }}</span>
          <span class="ask_user_profile label me">ME</span>
        {{ } else { }}
          <span class="ask_user_id">{{= ask.user.string_id }}</span>
          <span class="ask_user_profile {{= gender }}">{{= get_user_ages(ask.user.birthday) }}</span>
        {{ } }}
        <div class="ask_count_span"><i class="vaskit_icon comment_icon"></i> <span class="ask_comment_count">{{= ask.left_ask_deal.comment_count + ask.right_ask_deal.comment_count }}</span></div>
        <div class="ask_count_span"><i class="vaskit_icon {{= already_like ? 'is_liked' : '' }} ask_like_icon"></i> <span class="ask_like_count">{{= ask.like_count }}</span></div>
      </div>
      <div class="ask_message text_box_short">
        {{= ask.message.length > 0 ? taggingKeywords(ask.message, true) : '도와주세요!' }}
      </div>
      <div class="ask_message_more"><i class="fa fa-angle-double-right"></i></div>
    </div>
    <div class="clearfix">
      <div class="vs_result">
        {{= askResultTemplate({ type: '전체', left_count: left_count, right_count: right_count, total_count: total_count }) }}
      </div>
      <div class="vs_help">
        <div class="vs_before_text">
          <i class="fa fa-hand-pointer-o"></i> 상세한 내용을 보시려면 터치하세요!
        </div>
        <div class="vs_help_text">
          <i class="fa fa-hand-pointer-o"></i> vs버튼을 좌우로 움직여 투표에 참여하세요!
        </div>
        <div class="vs_help_menu">
          {{ if (current_user == null || current_user.id != ask.user_id) { }}
            <div class="vs_help_menu_left ask_like_btn ask_like_text {{= already_like ? 'is_liked' : '' }}" onclick="window.event.cancelBubble = true; like_ask({{= ask.id }});">공감해요 <i class="vaskit_icon {{= already_like ? 'is_liked' : '' }} ask_like_icon"></i></div>
            <div class="vs_help_menu_center" onclick="go_url('ask', {{= ask.id }});">댓글달기 <i class="vaskit_icon comment_icon"></i></div>
            <div class="vs_help_menu_right" onclick="go_url('share', 'ask, {{= ask.id }}');">공유하기 <i class="vaskit_icon share_icon"></i></div>
          {{ } else { }}
            <div class="vs_help_menu_left" onclick="go_url('ask', {{= ask.id }});">내용보기 <i class="fa fa-check"></i></div>
            {{ if (!ask.be_completed) { }}
              <div class="vs_help_menu_center" onclick="go_url('ask_form', {{= ask.id }}); window.event.cancelBubble = true;">수정하기 <i class="fa fa-edit"></i></div>
            {{ } else { }}
              <div class="vs_help_menu_center">종료한 투표</div>
            {{ } }}
            <div class="vs_help_menu_right" onclick="go_url('share', 'ask, {{= ask.id }}');">공유하기 <i class="vaskit_icon share_icon"></i></div>
          {{ } }}
        </div>
      </div>
      <div class="ask_image_box">
        <i class="fa fa-angle-left ask_image_background"></i>
        <span class="ask_image_background cancel">&times;</span>
        <i class="fa fa-angle-right ask_image_background"></i>
        <img class="ask_image left" src="{{= get_image_url(ask.left_ask_deal, 'ask_deals', 'normal') }}" onerror="imgError(this);">
        <img class="ask_image right" src="{{= get_image_url(ask.right_ask_deal, 'ask_deals', 'normal') }}" onerror="imgError(this);">
        {{ if (current_user && current_user.id == ask.user_id) { }}
          {{ var left_ratio = total_count == 0 ? '0' : (left_count / ( left_count + right_count ) * 100).toFixed() }}
          {{ var right_ratio = total_count == 0 ? '0' : (right_count / ( left_count + right_count ) * 100).toFixed() }}
          {{ if (!ask.be_completed && total_count == 0) { }}
            <span class="my_ask_vote_count blank"><small>이제 곧 투표가 시작됩니다 😬</small></span>
          {{ } else if (ask.be_completed) { }}
            {{ var is_select_left = ask.ask_complete.ask_deal_id == ask.left_ask_deal_id }}
            {{ var is_select_right = ask.ask_complete.ask_deal_id == ask.right_ask_deal_id }}
            {{ left_count = ask.ask_complete.left_vote_count }}
            {{ right_count = ask.ask_complete.right_vote_count }}
            {{ total_count = left_count + right_count }}
            {{ left_ratio = total_count == 0 ? '0' : (left_count / ( left_count + right_count ) * 100).toFixed() }}
            {{ right_ratio = total_count == 0 ? '0' : (right_count / ( left_count + right_count ) * 100).toFixed() }}
            {{ var star_point = '' }}
            {{ if (ask.ask_complete.star_point === null) { }}
              {{ star_point = '-' }}
            {{ } else { }}
              {{ for (var i=0; i < ask.ask_complete.star_point; i++) { }}
                {{ star_point += '&#xf005;' }}
              {{ } }}
              {{ for (var j=0; j < 5-ask.ask_complete.star_point; j++) { }}
                {{ star_point += '&#xf006;' }}
              {{ } }}
            {{ } }}
            <span class="my_ask_vote_count left {{= is_select_left ? 'on' : '' }}" star="{{= star_point }}">{{= left_ratio }}<small>%</small></span>
            <span class="my_ask_vote_count right {{= is_select_right ? 'on' : '' }}" star="{{= star_point }}">{{= right_ratio }}<small>%</small></span>
          {{ } else { }}
            <span class="my_ask_vote_count left">{{= left_ratio }}<small>%</small></span>
            <span class="my_ask_vote_count right">{{= right_ratio }}<small>%</small></span>
          {{ } }}
          <div class="ask_completed {{= ask.be_completed ? 'on' : '' }}">종료한 투표입니다</div>
        {{ } }}
        <span class="ask_title_label text_box_short left">{{= ask.left_ask_deal.title }}</span>
        <span class="ask_title_label text_box_short right">{{= ask.right_ask_deal.title }}</span>
      </div>
      {{ if (current_user == null || current_user.id != ask.user_id) { }}
        <div class="vs_btn {{= is_voted ? '' : 'animated rubberBand' }} {{= vote_direction }}" onanimationstart="vs_init($(this));" onmouseover="vs_init($(this));" onanimationend="$(this).removeClass('animated rubberBand');" vote-id="{{= vote_id }}" vote-direction="{{= vote_direction }}">vs</div>
      {{ } }}
    </div>
  </div>
</script>

<script>
  var asksListTemplate = _.template($('#asksListTemplate').html());
  var askThumbnailTemplate = _.template($('#askThumbnailTemplate').html());
</script>

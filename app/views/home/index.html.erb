<% case @type %>
<% when "user", "hash_tag", "ask_deal", "brand", "none" %>
	<%= render :partial => "common_partial/header_1", :locals => {:title => "검색결과"} %>
<% when "my_ask" %>
	<%= render :partial => "common_partial/header_1", :locals => {:title => "히스토리 : Asks"} %>
<% when "vote_ask" %>
	<%= render :partial => "common_partial/header_1", :locals => {:title => "히스토리 : Votes"} %>
<% when "comment_ask" %>
	<%= render :partial => "common_partial/header_1", :locals => {:title => "히스토리 : Comments"} %>
<% when "my_ask_in_progress" %>
	<%= render :partial => "common_partial/header_1", :locals => {:title => "진행 중인 질문"} %>
<% else %>
	<%= render :partial => "common_partial/header" %>
<% end %>

<%= render :partial => "common_partial/search" %>
<%= render :partial => "common_partial/category" %>
<%= render :partial => "common_partial/more_popup" %>
<%= render :partial => "common_partial/share_popup" %>

<div id="asks" style="padding:9px 12px;"></div>
<div class="home-float-btn">
	<% if current_user %>
		<a href="/asks/new"><img src="/images/home/writing.png"></a>
	<% else %>
		<a href="#" onclick="notify('회원가입 후<br />질문을 올릴 수 있습니다.'); return false;"><img src="/images/home/writing.png"></a>
	<% end %>
</div>

<% if @asks && @asks.length == Ask::ASK_PER %>
	<p id="endless_loading" style="margin-top:30px;">
		<img style="width:90px; margin-bottom:-7px;" src="/images/common/loading.gif" />
	</p>
<% end %>

<script type="text/template" id="ask-template">
	<div style="border:1px solid #dbdbdb; background-color:#fff; margin-bottom:9px; position:relative;">
		{{ if( ask.category){ }}
		<div style="text-align:left;  padding:12px 12px 0 12px;">
			<span class="category">{{= ask.category.name }}</span>
		</div>
		{{ }else{ }}
		<div style="text-align:left;  padding:12px 12px 0 12px;">
			<span class="category_none">관심사 미설정</span>
		</div>
		{{ } }}
		{{ price = 0 }}
		{{ if (ask.left_ask_deal.price != null){ }}
			{{ price = price + ask.left_ask_deal.price}}
		{{ } }}
		{{ if (ask.right_ask_deal.price != null){ }}
			{{ price = price + ask.right_ask_deal.price}}
		{{ } }}
		{{ price = price/2 }}
		{{ if (price > 10000){ }}
			{{ price = Math.round(price/10000) + "만" }}
		{{ } }}
		<span style="position:absolute; right:12px; top:12px; color:#9e9fa3; font-size:12px;">
			<img src="/images/home/vote.png" style="width:12px; margin:0 2px -1px 0;" /><span id="ask_{{=ask.id}}_vote_count">{{= ask.left_ask_deal.vote_count + ask.right_ask_deal.vote_count}}</span>
			{{ if (price != 0){ }}
				<img src="/images/home/money.png" style="width:12px; margin:0 2px -1px 2px;" />{{= numberWithCommas(price) }}
			{{ } }}
			<img src="/images/home/hour.png" style="width:12px; margin:0 2px -1px 2px;" />{{= get_past_time(ask.created_at) }}
		</span>
		<div style="text-align:left; padding:9px 80px 9px 12px; position:relative;">
			{{ if( ask.user){ }}
				<p style="margin:0; color:#998675; font-size:17px;">@{{= ask.user.string_id }}</p>
			{{ } }}
			<p id="ask_{{=ask.id}}_message" style="margin:2px 0 0 0; color:#383838; font-size:13px;">
				{{ if( ask.message){ }}
					{{= ask.message }}
				{{ }else{ }}
					둘중 하나를 골라주세요.
				{{ } }}
			</p>
			<span style="position:absolute; right:10px; top:29px; color:#9e9fa3; font-size:11px;">
				<a href="#" onclick="show_share_popup({{=ask.id}}, '{{=ask.user.string_id}}', '{{= ask.left_ask_deal.title }}', '{{=ask.right_ask_deal.title}}'); return false;"><img src="/images/home/share.png" style="width:24px;" /></a>
				{{ if (ask.user_id != current_user_id || ask.ask_complete == null){ }} 
				<a href="#" onclick="show_more_popup('ask', {{=ask.id}}, {{=ask.user_id}}, {{= current_user_id }}); return false;"><img src="/images/home/more.png" style="width:24px; margin-left:8px;" /></a>
				{{ } }}
			</span>
		</div>
		<div id="ask_deal_{{=ask.id}}" style="position:relative;">
			{{ var askDealTemplate = _.template($('#ask-deal-template').html()) }}
	        {{= askDealTemplate({my_votes: my_votes, ask: ask}) }}
		</div>
		<a href="/asks/{{=ask.id}}" style="padding:12px 12px 6px 12px; display:block;">
			<span style="float:left; font-size:13px; color:#9b9fa2"><img src="/images/home/comment_l.png" style="width:16px; margin:0 4px -2px 0;">{{=ask.left_ask_deal.comment_count}}</span>
			<img style="width:76px; margin-top:-1px;" src="/images/home/details_on.png" />
			<span style="float:right; font-size:13px; color:#9b9fa2">{{=ask.right_ask_deal.comment_count}}<img src="/images/home/comment_r.png" style="width:16px; margin:0 0 -2px 4px;"></span>
		</a>
	</div>
</script>

<script type="text/template" id="ask-deal-template">
	{{ left_ask_deal = ask.left_ask_deal }}
	{{ right_ask_deal = ask.right_ask_deal }}
	{{ already_vote = $.grep(my_votes, function(obj) { return obj.ask_id === ask.id }) }}
	<table cellspacing="0" cellpadding="0" style="width:100%;">
		<tr>
			<td style="width:50%; position:relative;">
		  		<img src='{{= get_image_url(left_ask_deal, "ask_deals", "normal") }}' style="width:100%; display:block;" />
		  		{{ if( ask.user_id != current_user_id && already_vote.length == 0 ){ }}
		  		<a class="vote_btn_{{=ask.id}}" href="#" onclick="vote_ask_deal({{=left_ask_deal.id}}, true); return false;"><img style="width:100px; position:absolute; left:50%; margin-left:-50px; bottom:16px;" src="/images/home/vote_btn.png" /></a>
		  		{{ } }}
			</td>
			<td style="width:50%; position:relative;">
				<img src='{{= get_image_url(right_ask_deal, "ask_deals", "normal") }}' style="width:100%; display:block;" />
				{{ if( ask.user_id != current_user_id && already_vote.length == 0 ){ }}
				<a class="vote_btn_{{=ask.id}}" href="#" onclick="vote_ask_deal({{=right_ask_deal.id}}, false); return false;"><img style="width:100px; position:absolute; left:50%; margin-left:-50px; bottom:16px;" src="/images/home/vote_btn.png" /></a>
				{{ } }}
			</td>
		</tr>
	</table>
	{{ if( ask.user_id == current_user_id || already_vote.length != 0 ){ }}
		{{ if (ask.user_id == current_user_id){ }}
			<div style="background:url('/images/home/vote_result_none.png'); background-size:100% 100%; overflow: hidden; position:absolute; left:0; top:0; width:100%; height:100%;"></div>
		{{ }else if(ask.left_ask_deal_id == already_vote[0].ask_deal_id){ }}
			<div style="background:url('/images/home/vote_result_l.png'); background-size:100% 100%; overflow: hidden; position:absolute; left:0; top:0; width:100%; height:100%;"></div>
		{{ }else{ }}
			<div style="background:url('/images/home/vote_result_r.png'); background-size:100% 100%; overflow: hidden; position:absolute; left:0; top:0; width:100%; height:100%;"></div>
		{{ } }}
		
		{{ total_count = ask.left_ask_deal.vote_count + ask.right_ask_deal.vote_count }}
		{{ if (ask.user_id == current_user_id && total_count == 0){ }}
			{{ left_ratio = 0 }}
			{{ right_ratio = 0 }}
		{{ }else{ }}
			{{ left_ratio = Math.round(ask.left_ask_deal.vote_count/total_count * 100) }}
			{{ right_ratio = Math.round(ask.right_ask_deal.vote_count/total_count * 100) }}
		{{ } }}
		
		{{left_background = "#fff"}}
		{{right_background = "#fff"}}
		{{ if (left_ratio > right_ratio){ }}
			{{left_background = "#ee6e01"}}
		{{ }else if(left_ratio < right_ratio){ }}
			{{right_background = "#ee6e01"}}
		{{ } }}
		<table cellspacing="0" cellpadding="0" style="position:absolute; bottom:0; width:100%; background-color:#4b3d3d; color:#fff; font-size:12px; font-weight:bold; height:32px;">
			<tr>
				<td class="vote-result-td" style="text-align:right; padding:6px 0 4px 0px;">
					<span style="float:left; margin-left:10px;">{{= left_ratio }}%</span>
					<span style="float:right; margin-top:4px; width:{{= Math.round(left_ratio * 0.6) + 2 }}%; height:5px; background-color:{{=left_background}};">&nbsp;</span>
				</td>
				<td style="min-width:56px; padding:6px 0 4px 0px;">
					투표 결과
				</td>
				<td class="vote-result-td" style="text-align:left; padding:6px 0 4px 0px;">
					<span style="float:right; margin-right:10px;">{{= right_ratio }}%</span>
					<span style="float:left; margin-top:4px; width:{{= Math.round(right_ratio * 0.6) + 2 }}%; height:5px; background-color:{{=right_background}};">&nbsp;</span>
				</td>
			</tr>
		</table>
	{{ } }}
</script>

<script> 
	var current_user_id = 0;
 	<% if current_user %>
 		current_user_id = <%= current_user.id %>;
 	<% end %>
	
	var asks = <%= raw @asks.to_json %>;
	var my_votes = <%= raw @my_votes.to_json %>;
	var my_vote_count = <%= @my_votes.length %>;
	var askTemplate = _.template( $('#ask-template').html() );
	
	
	var ranking_asks = <%= raw @ranking_asks.to_json %>;
	
	for(var i=0; i < ranking_asks.length; i++) {
		var ask = ranking_asks[i]
        $('#asks').append(askTemplate({ask: ask}));
        var hash_tags = ask.message.match(/#(\S+)/g);
        $.each(hash_tags, function( index, hash_tag ) {
		  	$("#ask_"+ask.id+"_message").highlight(hash_tag, { element:'a', className: 'hash_tag '+index});
		  	hash_tag = hash_tag.replace('#', '').replace("?","")
			$("#ask_"+ask.id+"_message ."+index).attr({href:"/?keyword="+hash_tag+"&type=hash_tag"});
		});
	}
	
	for(var i=0; i < asks.length; i++) {
		var ask = asks[i]
        $('#asks').append(askTemplate({ask: ask}));
        var hash_tags = ask.message.match(/#(\S+)/g);
        $.each(hash_tags, function( index, hash_tag ) {
		  	$("#ask_"+ask.id+"_message").highlight(hash_tag, { element:'a', className: 'hash_tag '+index});
		  	hash_tag = hash_tag.replace('#', '').replace("?","")
			$("#ask_"+ask.id+"_message ."+index).attr({href:"/?keyword="+hash_tag+"&type=hash_tag"});
		});
	}
	
	
	function vote_ask_deal(ask_deal_id, is_left){
	 	if (current_user_id == 0 && my_vote_count > 4){
	 		notify("결과를 더 알고 싶으실 경우 회원 가입해 주세요");
	 	}else{
	 		$.ajax({
		        url: "/votes.json",
		        type: 'POST',
		        data: {'ask_deal_id': ask_deal_id, 'is_left':is_left },
		        dataType: 'json',
		        error: function(){
		            return false;
		        },
		        success: function(data){
		        	my_votes.push(data.vote);
		        	var askDealTemplate = _.template( $('#ask-deal-template').html() );
		        	$('#ask_deal_'+data.ask.id).html(askDealTemplate({my_votes: my_votes, ask:data.ask }));
		        	
	        		notify("투표 완료");
	        		var vote_count_span = $("#ask_"+data.ask.id+"_vote_count");
	        		vote_count_span.html( parseInt(vote_count_span.html()) + 1 );
	        		my_vote_count = my_vote_count + 1;
		        },
		        beforeSend: function(){
		       		$(".loading").show();
		        },
		        complete: function(){
		        	$(".loading").hide();
		        }
			});
	 	}
	}
	
	
	var ready = function() {
		if (asks.length == <%= Ask::ASK_PER %>){
			setInterval("checkScroll()", 1000);
		}
	};
	
	$(document).ready(ready);
	$(document).on('page:load', ready);
	
	var currentPage = 1
	var is_more_asks = true;
	function checkScroll() {
	  if (window.location.pathname == "/" && nearBottomOfPage() && is_more_asks) { // 크롬에서 javascript 코드를 캐시하는거 같아서 url 분석해서 ask인 경우에만 작동하도록 변경
	    currentPage ++;
	    
	    $.ajax({
	        url: window.location.href,
	        data: {'page': currentPage},
	        dataType: "json",
	        type: 'GET',
	        error: function(){
	            return false;
	        },
	        success: function(data){
	        	var more_asks = data.asks;
	        	if( more_asks.length == 0 ){
	        		is_more_asks = false;
	        		$("#endless_loading").hide();
	        	}else{
	        		if( more_asks.length < <%= Ask::ASK_PER %> ){
	        			is_more_asks = false;
	        			$("#endless_loading").hide();
	        		}
	        		
	        		for(var i=0; i < more_asks.length; i++) {
						var ask = more_asks[i]
				        $('#asks').append(askTemplate({ask: ask}));
				        var hash_tags = ask.message.match(/#(\S+)/g);
				        $.each(hash_tags, function( index, hash_tag ) {
						  	$("#ask_"+ask.id+"_message").highlight(hash_tag, { element:'a', className: 'hash_tag '+index});
						  	hash_tag = hash_tag.replace('#', '').replace("?","")
							$("#ask_"+ask.id+"_message ."+index).attr({href:"/?keyword="+hash_tag+"&type=hash_tag"});
						});
					}
	        	}
	        },
	        beforeSend: function(){
            },
            complete: function(){
            }
		});
	  }
	}
	
	
</script>


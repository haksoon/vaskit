<% case @type %>
<% when "user", "hash_tag", "ask_deal", "brand", "none" %>
	<%= render :partial => "common_partial/header_3" %>
	<%= render :partial => "common_partial/search" %>
	<p class="chat_bubble" style="margin-top:65px;">
		<% if @type == "user" %>
			<span style="color:#998674; font-weight:bold;"><i class="fa fa-user"></i>&nbsp;<%= flash[:keyword] %></span>&nbsp;유저 검색 결과입니다.
		<% elsif @type == "hash_tag" %>
			<span style="color:#998674; font-weight:bold;"><i class="fa fa-slack" style="transform:rotateY(180deg) skewY(18deg);"></i>&nbsp;<%= flash[:keyword] %></span>&nbsp;해쉬태그 검색 결과입니다.
		<% elsif @type == "ask_deal" %>
			<span style="color:#998674; font-weight:bold;"><i class="fa fa-cube"></i>&nbsp;<%= flash[:keyword] %></span>&nbsp;제품명 검색 결과입니다.
		<% elsif @type == "brand" %>
			<span style="color:#998674; font-weight:bold;"><i class="fa fa-tag"></i>&nbsp;<%= flash[:keyword] %></span>&nbsp;브랜드 검색 결과입니다.
		<% elsif @type == "none" %>
			<span style="color:#998674; font-weight:bold;"><i class="fa fa-search"></i>&nbsp;<%= flash[:keyword] %></span>&nbsp;통합 검색 결과입니다.
		<% end %>
	</p>
<% when "my_ask", "vote_ask", "comment_ask", "my_ask_in_progress" %>
	<%= render :partial => "common_partial/header_3" %>
	<p class="chat_bubble">
		<% if @type == "my_ask" %>
			<span style="color:#998674; font-weight:bold;"><%= current_user.string_id %></span>님은 지금까지 <span style="color:#998674; font-weight:bold;"><%= @my_ask_count %>개</span>의 질문을 던지셨군요!<br>와우! 많은 고민을 해결하셨나요?
		<% elsif @type == "vote_ask" %>
			<span style="color:#998674; font-weight:bold;"><%= current_user.string_id %></span>님은 지금까지 <span style="color:#998674; font-weight:bold;"><%= @my_vote_count %>개</span>의 투표에 참여했군요!<br>와우! 많은 이들의 탈모를 막아주었습니다!
		<% elsif @type == "comment_ask" %>
			<span style="color:#998674; font-weight:bold;"><%= current_user.string_id %></span>님은 지금까지 <span style="color:#998674; font-weight:bold;"><%= @my_comment_count %>개</span>의 의견을 남기셨군요!<br>와우! 우리 모두 수다쟁이를 좋아한답니다!
		<% elsif @type == "my_ask_in_progress" %>
			<span style="color:#998674; font-weight:bold;"><%= current_user.string_id %></span>님은 현재 <span style="color:#998674; font-weight:bold;"><%= @in_progress_count %>개</span>의 질문을 진행중입니다.<br>더보기 버튼을 눌러 투표를 종료할 수 있는 것, 알고 계셨나요?
		<% end %>
	</p>
<% else %>
	<%= render :partial => "common_partial/header" %>
	<%= render :partial => "common_partial/search" %>
	<p class="chat_bubble" style="margin-top:65px;">
		투표하기 버튼을 눌러 투표에 참여해보세요! Let's VASKIT!
	</p>
<% end %>


<div id="asks" style="padding:12px 12px 0px;"></div>
<div class="home-float-btn-area">
	<% if current_user %>
		<a href="/asks/new" style="display:block;">
			<div class="home-float-btn">
				<i class="fa fa-plus"></i>
			</div>
			<div class="home-float-btn-text">질문<br>하기</div>
		</a>
	<% else %>
		<a href="#" onclick="visitor_new_ask(); return false;" style="display:block;"><div class="home-float-btn"><i class="fa fa-plus"></i></div><div class="home-float-btn-text">질문<br>하기</div></a>
	<% end %>
</div>

<% if @asks && @asks.length == Ask::ASK_PER %>
	<p id="endless_loading" style="margin-top:10px;">
		<img style="width:90px; margin-bottom:-7px;" src="/images/common/loading.gif" />
	</p>
<% end %>

<script type="text/template" id="ask-template">
  <div class="table_div" style="margin-bottom:0px; border-radius:0 3px 0 0; overflow:hidden;">
		<span class="input_icon left_input" onclick="category_on(); return false;" style="border-bottom:none; border-radius:0; background-color:rgba(153,134,116,0.8); color:#fff; cursor:pointer;"><i class="fa fa-filter"></i></span>
    {{ if (ask.category) { }}
    	<span class="category" onclick="category_on(); return false;">{{= ask.category.name }}</span>
    {{ }else{ }}
    	<span class="category none" onclick="category_on(); return false;">관심사 미설정</span>
    {{ } }}
		<div style="position:absolute; bottom:0; right:3px;">
			<a class="share_icon" style="width:80px;" href="#" onclick="show_share_popup({{=ask.id}}, '{{=ask.user.string_id}}', '{{= ask.left_ask_deal.title }}', '{{=ask.right_ask_deal.title}}'); return false;"><i class="fa fa-share" style="font-size:10px; color:#998674;"></i>&nbsp;공유하기</a>
			{{ if (ask.be_completed == false){ }}
        <a class="more_icon" style="width:70px;" href="#" onclick="show_more_popup('ask', {{=ask.id}}, {{=ask.user_id}}, {{= current_user_id }}); return false;"><i class="fa fa-chevron-down" style="font-size:10px; color:#998674;"></i>&nbsp;더보기</a>
			{{ } }}
		</div>
  </div>

	<div class="content_box">
		<div style="text-align:left; padding:15px; position:relative; background-color:#fff;">
			{{ if (ask.user) { }}
			  {{ gender_css = "color:#0389ed; border: solid 1px #0389ed;" }}
			  {{ if (!ask.user.gender) { }}
			    {{ gender_css = "color:#ea065e; border: solid 1px #ea065e;" }}
			  {{ } }}
			  <p style="margin:0px 5px 0px -1px; font-size:12px; padding:3px 4px; float:left; font-weight:bold; opacity:0.8; border-radius:5px; {{= gender_css}} border-right-width:2px; border-bottom-width:2px;">
					{{ if (ask.user.gender){ }}
						<i class="fa fa-male" style="margin-right:-2px;"></i>
					{{ }else{ }}
						<i class="fa fa-female" style="margin-right:-2px;"></i>
					{{ } }}
					{{= get_user_ages(ask.user.birthday) }}
				</p>
				<p style="margin:3px 0 0 0; color:#998675; font-size:17px; float:left; max-width:150px; overflow:hidden; text-overflow:ellipsis;">{{= ask.user.string_id }}</p>
				<span style="float:right; padding-top:5px; color:#9e9fa3; font-size:12px;">
					<i class="fa fa-check-circle-o" style="font-size:13px; margin:0 3px;"></i><span id="ask_{{=ask.id}}_vote_count">{{= ask.left_ask_deal.vote_count + ask.right_ask_deal.vote_count}}표</span>
				</span>
				{{ if (ask.be_completed == true) { }}
					<div style="color: #fff; background: #4b3d3d; padding: 4px 5px 5px 5px; font-size: 11px; float: right; border-radius: 6px; margin-right: 5px; border-right: 2px solid #998674; border-bottom: 2px solid #998674;">투표종료</div>
				{{ } }}
			{{ } }}
			<p id="ask_{{=ask.id}}_message" style="clear:both; margin:0; padding-top:10px; color:#383838; font-size:13px; line-height:1.4;">
				{{ if( ask.message){ }}
					{{ ask_message = ask.message.replace(new RegExp('\r?\n', 'g'), '<br />') }}
					{{= ask_message }}
				{{ }else{ }}
					둘중 하나를 골라주세요.
				{{ } }}
			</p>
		</div>
		<div id="ask_deal_{{=ask.id}}" style="position:relative;">
			{{ var askDealTemplate = _.template($('#ask-deal-template').html()) }}
	    {{= askDealTemplate({my_votes: my_votes, ask: ask}) }}
		</div>
		<a class="card_detail" href="/asks/{{=ask.id}}" target="_blank">
			<span style="float:left;"><i class="fa fa-comment" style="font-size:15px; margin-right:3px;"></i>{{=ask.left_ask_deal.comment_count}}</span>
			<span><i class="fa fa-angle-double-down" style="font-size:15px; vertical-align:top;">&nbsp;</i>상세 열기</span>
			<span style="float:right;">{{=ask.right_ask_deal.comment_count}}<i class="fa fa-comment" style="font-size:15px; margin-left:3px; transform:rotateY(180deg);"></i></span>
		</a>
	</div>
</script>

<script type="text/template" id="ask-deal-template">
	{{ left_ask_deal = ask.left_ask_deal }}
	{{ right_ask_deal = ask.right_ask_deal }}
	{{ already_vote = $.grep(my_votes, function(obj) { return obj.ask_id === ask.id }) }}
	<table cellspacing="0" cellpadding="0" style="width:100%;">
		<tr>
			<td style="width:50%; position:relative; overflow:hidden;">
  	    <a href="#" onclick="ask_image_on({{=ask.id}}, true); return false;">
    		  <img src='{{= get_image_url(left_ask_deal, "ask_deals", "normal") }}' class="card_image"/>
					<p class="card_image_expander"><i class="fa fa-expand"></i></p>
    		</a>
				<div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 1px; background-color: #fff;"></div>
    		{{ if( ask.user_id == current_user_id || already_vote.length != 0 || ask.be_completed){ }}
      		{{ if ((ask.user_id == current_user_id || ask.be_completed) || ask.right_ask_deal_id == already_vote[0].ask_deal_id){ }}
            <a href="#" onclick="ask_image_on({{=ask.id}}, true); return false;" class="card_image_overlay"></a>
          {{ }else if(ask.left_ask_deal_id == already_vote[0].ask_deal_id){ }}
            <a href="#" onclick="ask_image_on({{=ask.id}}, true); return false;" class="card_image_overlay">
              <img src="/images/home/vote_result_check.png" style="width:50%; margin-top:25%;">
            </a>
          {{ } }}
        {{ } }}
			</td>
			<td style="width:50%; position:relative; overflow:hidden;">
			  <a href="#" onclick="ask_image_on({{=ask.id}}, false); return false;">
				  <img src='{{= get_image_url(right_ask_deal, "ask_deals", "normal") }}' class="card_image"/>
					<p class="card_image_expander"><i class="fa fa-expand"></i></p>
				</a>
				<div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 1px; background-color: #fff;"></div>
				{{ if( ask.user_id == current_user_id || already_vote.length != 0 || ask.be_completed){ }}
  				{{ if ((ask.user_id == current_user_id || ask.be_completed) || ask.left_ask_deal_id == already_vote[0].ask_deal_id){ }}
            <a href="#" onclick="ask_image_on({{=ask.id}}, false); return false;" class="card_image_overlay"></a>
          {{ }else if(ask.right_ask_deal_id == already_vote[0].ask_deal_id){ }}
            <a href="#" onclick="ask_image_on({{=ask.id}}, false ); return false;" class="card_image_overlay">
              <img src="/images/home/vote_result_check.png" style="width:50%; margin-top:25%;">
            </a>
          {{ } }}
        {{ } }}
			</td>
		</tr>
	</table>
	{{ if( ask.user_id != current_user_id && already_vote.length == 0 && ask.be_completed == false ){ }}
		<div class="table_div" style="margin-bottom:0px;">
			<a class="vote_btn_{{=ask.id}} vote_btn" href="#" onclick="vote_ask_deal({{=left_ask_deal.id}}, true); return false;" style="float:left;">투표하기&nbsp;<i class="fa fa-play"></i></a>
			<a class="vote_btn_{{=ask.id}} vote_btn" href="#" onclick="vote_ask_deal({{=right_ask_deal.id}}, false); return false;" style="float:right; border-left:1px solid #fff;">투표하기&nbsp;<i class="fa fa-play"></i></a>
		</div>
	{{ } }}
	{{ if( ask.user_id == current_user_id || already_vote.length != 0 || ask.be_completed){ }}
		<div id="main_vote_count">
			{{ total_count = ask.left_ask_deal.vote_count + ask.right_ask_deal.vote_count }}
			{{ if (ask.user_id == current_user_id && total_count == 0){ }}
				{{ left_ratio = 0 }}
				{{ left_ratio_full = 0 }}
				{{ right_ratio = 0 }}
				{{ right_ratio_full = 0 }}
			{{ }else{ }}
				{{ left_ratio = Math.round(ask.left_ask_deal.vote_count/total_count * 80) }}
				{{ left_ratio_full = Math.round(ask.left_ask_deal.vote_count/total_count * 100) }}
				{{ right_ratio = Math.round(ask.right_ask_deal.vote_count/total_count * 80) }}
				{{ right_ratio_full = Math.round(ask.right_ask_deal.vote_count/total_count * 100) }}
			{{ } }}

			{{ left_background = "#ffcc5a" }}
			{{ left_font_weight = "bold" }}
			{{ right_background = "#ffcc5a" }}
			{{ right_font_weight = "bold" }}
			{{ if (left_ratio > right_ratio){ }}
				{{ right_background = "#fff" }}
				{{ right_font_weight = "normal" }}
			{{ }else if(left_ratio < right_ratio){ }}
				{{ left_background = "#fff" }}
				{{ left_font_weight = "normal" }}
			{{ } }}
			<table cellspacing="0" cellpadding="0" style="width:100%; background-color:rgba(75,61,61,0.8); color:#fff; font-size:12px; font-weight:bold; height:40px;">
				<tr>
					<td class="vote-result-td">
						<span class="vote-result-bar-left" style="width:{{=left_ratio}}%; background-color:{{=left_background}};">&nbsp;</span>
						<span class="vote-result-num-left" style="float:right; margin-right:3px; font-weight:{{=left_font_weight}}; color:{{=left_background}};">{{=left_ratio_full}}%</span>
					</td>
					<td class="vote-result-td-title">
						A vs B
					</td>
					<td class="vote-result-td">
						<span class="vote-result-bar-right" style="width:{{=right_ratio}}%; background-color:{{=right_background}};">&nbsp;</span>
						<span class="vote-result-num-right" style="float:left; margin-left:3px; font-weight:{{=right_font_weight}}; color:{{=right_background}};">{{=right_ratio_full}}%</span>
					</td>
				</tr>
			</table>
		</div>
	{{ } }}
</script>

<script>
	var current_user_id = 0;
 	<% if current_user %>
 		current_user_id = <%= current_user.id %>;
 	<% end %>

	var asks = <%= raw @asks.to_json %>;
	var my_votes = <%= raw @my_votes.to_json %>;
	var my_vote_count = <%= @my_votes.length %>;
	var askTemplate = _.template( $('#ask-template').html() );

	<% unless @ranking_asks.blank? %>
	var ranking_asks = <%= raw @ranking_asks.to_json %>;

	for(var i=0; i < ranking_asks.length; i++) {
		var ask = ranking_asks[i]
        $('#asks').append(askTemplate({ask: ask}));
        var hash_tags = ask.message.match(/#(\S+)/g);
        if (hash_tags != null) hash_tags.sort(function(a,b){ return b.length - a.length; }); // 긴 순서대로 정렬
        $.each(hash_tags, function( index, hash_tag ) {
          hash_tag = hash_tag.replace(",","");
  		  	$("#ask_"+ask.id+"_message").highlight(hash_tag, { element:'a', className: 'hash_tag '+index});
  		  	hash_tag = hash_tag.replace('#', '').replace("?","")
  			  $.each( $("#ask_"+ask.id+"_message ."+index), function( index2, element ){
            if ( $(element).parent().prop('nodeName') == "P"){
              $(element).attr({href:"/?keyword="+hash_tag+"&type=hash_tag"})
            }
          });
		    });
	}
	<% end %>

	for(var i=0; i < asks.length; i++) {
		var ask = asks[i]
        $('#asks').append(askTemplate({ask: ask}));
        var hash_tags = ask.message.match(/#(\S+)/g);
        if (hash_tags != null) hash_tags.sort(function(a,b){ return b.length - a.length; }); // 긴 순서대로 정렬
        $.each(hash_tags, function( index, hash_tag ) {
          hash_tag = hash_tag.replace(",","");
  		  	$("#ask_"+ask.id+"_message").highlight(hash_tag, { element:'a', className: 'hash_tag '+index});
  		  	hash_tag = hash_tag.replace('#', '').replace("?","")
  			  $.each( $("#ask_"+ask.id+"_message ."+index), function( index2, element ){
            if ( $(element).parent().prop('nodeName') == "P"){
              $(element).attr({href:"/?keyword="+hash_tag+"&type=hash_tag"})
            }
          });
  		  });
	}


	function vote_ask_deal(ask_deal_id, is_left){
	 	if (current_user_id == 0 && my_vote_count > 4){
	 		notify("회원가입 후<br />투표를 진행할 수 있습니다.");
      setTimeout("notify('<i class=\"fa fa-spinner fa-spin\"></i>&nbsp;회원가입 화면으로 이동합니다.')",1500);
			setTimeout('window.location.assign("http://vaskit.kr/etc/landing")',2500);
	 	}else{
	 		$.ajax({
		        url: "/votes.json",
		        type: 'POST',
		        data: {'ask_deal_id': ask_deal_id, 'is_left':is_left },
		        dataType: 'json',
		        error: function(){
		            return false;
		        },
		        success: function(data){
		        	my_votes.push(data.vote);
		        	var askDealTemplate = _.template( $('#ask-deal-template').html() );
		        	$('#ask_deal_'+data.ask.id).html(askDealTemplate({my_votes: my_votes, ask:data.ask }));
	        		notify("투표 완료");
							hover_action();
							graph_animation(data.ask.id);
	        		var vote_count_span = $("#ask_"+data.ask.id+"_vote_count");
	        		vote_count_span.html( parseInt(vote_count_span.html()) + 1 + "표" );
	        		my_vote_count = my_vote_count + 1;
		        },
		        beforeSend: function(){
		       		$(".loading").show();
		        },
		        complete: function(){
		        	$(".loading").hide();
		        }
			});
	 	}
	}


	var ready = function() {
		if (asks.length == <%= Ask::ASK_PER %>){
			setInterval("checkScroll()", 1000);
		}
	};

	$(document).ready(ready);
	$(document).on('page:load', ready);

	var currentPage = 1
	var is_more_asks = true;
	function checkScroll() {
	  if (window.location.pathname == "/" && nearBottomOfPage() && is_more_asks) { // 크롬에서 javascript 코드를 캐시하는거 같아서 url 분석해서 ask인 경우에만 작동하도록 변경
	    currentPage ++;

	    $.ajax({
	        url: window.location.href,
	        data: {'page': currentPage},
	        dataType: "json",
	        type: 'GET',
	        error: function(){
	            return false;
	        },
	        success: function(data){
	        	var more_asks = data.asks;
	        	$.merge(asks, more_asks);

	        	if( more_asks.length == 0 ){
	        		is_more_asks = false;
	        		$("#endless_loading").hide();
	        	}else{
	        		if( more_asks.length < <%= Ask::ASK_PER %> ){
	        			is_more_asks = false;
	        			$("#endless_loading").hide();
	        		}

	        		for(var i=0; i < more_asks.length; i++) {
    						var ask = more_asks[i]
    				        $('#asks').append(askTemplate({ask: ask}));
    				        var hash_tags = ask.message.match(/#(\S+)/g);
    				        if (hash_tags != null) hash_tags.sort(function(a,b){ return b.length - a.length; }); // 긴 순서대로 정렬
    				        $.each(hash_tags, function( index, hash_tag ) {
    				          hash_tag = hash_tag.replace(",","");
      						  	$("#ask_"+ask.id+"_message").highlight(hash_tag, { element:'a', className: 'hash_tag '+index});
      						  	hash_tag = hash_tag.replace('#', '').replace("?","")
      							  $.each( $("#ask_"+ask.id+"_message ."+index), function( index2, element ){
                        if ( $(element).parent().prop('nodeName') == "P"){
                          $(element).attr({href:"/?keyword="+hash_tag+"&type=hash_tag"})
                        }
                      });
    						    });
    					}
							hover_action();
	        	}
	        },
	        beforeSend: function(){
          },
          complete: function(){
          }
		});
	  }
	}

	$(document).ready(function(){
    hover_action();
  });

	function visitor_new_ask() {
		notify('회원가입 후<br />질문을 올릴 수 있습니다.');
		setTimeout("notify('<i class=\"fa fa-spinner fa-spin\"></i>&nbsp;회원가입 화면으로 이동합니다.')",1500);
		setTimeout('window.location.assign("http://vaskit.kr/etc/landing")',2500);
	}

</script>

<%= render :partial => "common_partial/category" %>
<%= render :partial => "common_partial/user" %>
<%= render :partial => "common_partial/footer" %>
<%= render :partial => "common_partial/more_popup" %>
<%= render :partial => "common_partial/share_popup" %>
<%= render :partial => "common_partial/ask_image" %>
